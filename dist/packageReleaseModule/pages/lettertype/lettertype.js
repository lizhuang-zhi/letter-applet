const initTagBgColor="#F8F8F8",initFontColor="#BBBEC2",initTagBorder="1rpx solid #ddd",chooseTagBgColor="#F9FDFB",chooseTagColor="#F0934F",chooseTagBorder="1rpx solid "+chooseTagColor,stampInitBorder="8rpx solid #F7F7F7",stampChooseBorder="8rpx solid #F0934F";let selectSorrowArr=[],selectDiaryWeatherArr=[],selectComplainWeatherArr=[],tools=require("../../utils/tools"),requestData=require("../../../utils/request"),swithArr=[{isShow:!0,tit:"允许收录到解忧信箱",cont:"保存历史足迹"},{isShow:!0,tit:"允许公开日记",cont:"开放自我心路"},{isShow:!1}],app=getApp();Page({data:{tagArr:[{tagName:"校园",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"社交",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"莫名",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"职场",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"情感",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"疾病",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"家庭",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder}],weatherDiaryArr:[{tagName:"晴天",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"多云",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"下雨",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"阴天",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder}],weatherComplainArr:[{tagName:"晴天",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"多云",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"下雨",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder},{tagName:"阴天",btnBgColor:initTagBgColor,BtnColor:initFontColor,btnBorder:initTagBorder}],stampArr:[],initValue:"",inputValue:"",type:"",switchVal:null,letterId:"",senderOpenId:"",baiduAiCheck:null,stampPic:""},bindTapSorrowTag(t){t=t.currentTarget.dataset.index;let e=this.data.tagArr;e[t].btnBorder==initTagBorder&&selectSorrowArr.length<3?(e[t].btnBgColor=chooseTagBgColor,e[t].BtnColor=chooseTagColor,e[t].btnBorder=chooseTagBorder,selectSorrowArr.push(e[t].tagName)):-1!=selectSorrowArr.indexOf(e[t].tagName)?(e[t].btnBgColor=initTagBgColor,e[t].BtnColor=initFontColor,e[t].btnBorder=initTagBorder,selectSorrowArr.splice(selectSorrowArr.indexOf(e[t].tagName),1)):wx.showToast({title:"最多只能选择三个标签",icon:"none"}),this.setData({tagArr:this.data.tagArr})},bindTapDiaryWeather(t){t=t.currentTarget.dataset.index;let e=this.data.weatherDiaryArr;e[t].btnBorder==initTagBorder&&selectDiaryWeatherArr.length<1?(e[t].btnBgColor=chooseTagBgColor,e[t].BtnColor=chooseTagColor,e[t].btnBorder=chooseTagBorder,selectDiaryWeatherArr.push(e[t].tagName)):-1!=selectDiaryWeatherArr.indexOf(e[t].tagName)?(e[t].btnBgColor=initTagBgColor,e[t].BtnColor=initFontColor,e[t].btnBorder=initTagBorder,selectDiaryWeatherArr.splice(selectDiaryWeatherArr.indexOf(e[t].tagName),1)):wx.showToast({title:"最多只能选择一种天气",icon:"none"}),this.setData({weatherDiaryArr:this.data.weatherDiaryArr})},bindTapComplainWeather(t){t=t.currentTarget.dataset.index;let e=this.data.weatherComplainArr;e[t].btnBorder==initTagBorder&&selectComplainWeatherArr.length<1?(e[t].btnBgColor=chooseTagBgColor,e[t].BtnColor=chooseTagColor,e[t].btnBorder=chooseTagBorder,selectComplainWeatherArr.push(e[t].tagName)):-1!=selectComplainWeatherArr.indexOf(e[t].tagName)?(e[t].btnBgColor=initTagBgColor,e[t].BtnColor=initFontColor,e[t].btnBorder=initTagBorder,selectComplainWeatherArr.splice(selectComplainWeatherArr.indexOf(e[t].tagName),1)):wx.showToast({title:"最多只能选择一种天气",icon:"none"}),this.setData({weatherComplainArr:this.data.weatherComplainArr})},RandomNameTap(){var t=tools.RandomPenName();console.log(t),this.setData({initValue:t})},stampClickObj(t){console.log(t.detail.clickObj);var e=t.detail.clickObj.index;let o=this.data.stampArr;t=this.data.stampPic;""==t&&o[e].picBorder==stampInitBorder?(o[e].picBorder=stampChooseBorder,this.setData({stampPic:o[e].stampUrl})):""!=t&&o[e].picBorder==stampInitBorder?wx.showToast({title:"最多只能选择一张邮票",icon:"none"}):""!=t&&o[e].picBorder==stampChooseBorder&&(o[e].picBorder=stampInitBorder,this.setData({stampPic:""})),this.setData({stampArr:o})},switchEvent(t){this.setData({switchVal:t.detail.switchValue})},inputeventTap(t){t=t.detail.obj.value;this.setData({initValue:t})},ConfirmSend(){var t=this.data.type;"解忧"==t?this.ConfirmSendSorrow():"日记"==t?this.ConfirmSendDiary():"吐槽"==t?this.ConfirmSendComplain():"解答"==t?this.ConfirmSendAnswer():console.log("未知类型，未做处理！！！")},ConfirmSendSorrow(){let e=this;var t=e.data.initValue,o=e.data.inputValue,r=app.globalData.openid,a=e.data.stampPic,n=1==e.data.baiduAiCheck?1:3;let i={penName:t,content:o,stampUrl:a,tapIds:selectSorrowArr.toString(),state:n,openId:r};console.log(i),0==selectSorrowArr.length?wx.showToast({title:"请选择标签",icon:"none"}):""==a?wx.showToast({title:"请选择邮票",icon:"none"}):wx.requestSubscribeMessage({tmplIds:["vuxCjKVvzbUWW1iHbMkSCmsBrpXWkXFPJ81S8nVWJdw"],success(t){console.log(t),e.sendSorrow(i)},fail:t=>{console.log(t),20004==t.errCode&&wx.showToast({title:"小主关闭了主开关，请在设置中打开~",icon:"none"})}})},sendSorrow(t){wx.showLoading({title:"发布中.."}),requestData.lettertypeLetterSend(t).then(o=>(console.log(o.data),new Promise((t,e)=>{200==o.data.resultCode?(wx.showToast({title:"发布成功",icon:"none",duration:1e3,image:"../../images/confirm.png"}),t("success")):(wx.showToast({title:"服务器开了个小差",icon:"none"}),e("error"))}))).then(t=>{"success"==t&&(wx.hideLoading({}),setTimeout(()=>{wx.switchTab({url:"/pages/index/index"})},1e3))})},ConfirmSendDiary(){var t=this.data.initValue,e=this.data.inputValue,o=app.globalData.openid,o={penName:t,content:e,state:1==this.data.baiduAiCheck?1:3,weather:selectDiaryWeatherArr.toString(),openId:o};console.log(o),0==selectDiaryWeatherArr.length?wx.showToast({title:"请选择标签",icon:"none"}):requestData.lettertypeDiarySend(o).then(o=>(console.log(o),new Promise((t,e)=>{200==o.data.resultCode?(wx.showToast({title:"发布成功",icon:"none",duration:1e3,image:"../../images/confirm.png"}),t("success")):(wx.showToast({title:"服务器开了个小差",icon:"none"}),e("error"))}))).then(t=>{"success"==t&&setTimeout(()=>{wx.switchTab({url:"/pages/index/index"})},1e3)})},ConfirmSendComplain(){let e=this;var t=app.globalData.userInfo.avatarUrl;let o=e.data.inputValue;var r=app.globalData.openid,a=e.data.initValue,n=1==e.data.baiduAiCheck?1:3,i=o.substring(0,-1=="。".indexOf(o)?30:"。".indexOf(o));let s={avatarUrl:t,penName:a,content:o,state:n,title:i,number:0,openId:r};console.log(s),wx.requestSubscribeMessage({tmplIds:["mghtoN9x1YBMmyWg9RtBlt8-XxHxMvEo8eAtHIazD34"],success(t){console.log(t),e.sendComplain(s)},fail:t=>{console.log(t),20004==t.errCode&&wx.showToast({title:"小主关闭了主开关，请在设置中打开~",icon:"none"})}})},sendComplain(t){wx.showLoading({title:"发布中.."}),requestData.lettertypeComplainSend(t).then(o=>(console.log(o),new Promise((t,e)=>{200==o.data.resultCode?(wx.showToast({title:"发布成功",icon:"none",duration:1e3,image:"../../images/confirm.png"}),t("success")):(wx.showToast({title:"服务器开了个小差",icon:"none"}),e("error"))}))).then(t=>{"success"==t&&(wx.hideLoading({}),setTimeout(()=>{wx.switchTab({url:"/pages/index/index"})},1e3))})},ConfirmSendAnswer(){var t={letterId:this.data.letterId,message:this.data.inputValue,sender:app.globalData.openid,senderPenName:this.data.initValue,recipient:this.data.senderOpenId};console.log(t),requestData.indexStampReply(t).then(o=>new Promise((t,e)=>{console.log(o.data),200==o.data.resultCode?(wx.showToast({title:"回信成功",image:"../../images/confirm.png",duration:1300}),wx.setStorage({key:"userBackLetterNum",data:{letterBackNum:0,judgeTime:new Date((new Date).setHours(24,0,0,0))}})):500==o.data.resultCode&&wx.showToast({title:"服务器出了个小差~",icon:"none"}),t("success")})).then(t=>{if("success"==t){let t=setTimeout(()=>{wx.switchTab({url:"/pages/index/index"}),clearTimeout(t)},1300)}})},Start(t){wx.showLoading({title:"加载中.."}),requestData.userStamp(t).then(r=>new Promise((t,e)=>{console.log(r.data.data);let o=r.data.data;o.forEach(t=>{t.picBorder=stampInitBorder}),this.setData({stampArr:o}),t("success")})).then(t=>{wx.hideLoading({})})},onLoad:function(t){this.setData({initValue:"酒醉的蝴蝶"}),this.setData({inputValue:JSON.parse(decodeURIComponent(t.subvalue)),letterId:t.letterId,senderOpenId:t.senderOpenId,baiduAiCheck:t.baiduAiCheck}),console.log(JSON.parse(decodeURIComponent(t.subvalue))),console.log("----\x3e "+t.senderOpenId);t=t.type;console.log(t),this.setData({type:t}),"解忧"==t?this.setData({swithObj:swithArr[0]}):"日记"==t?this.setData({swithObj:swithArr[1]}):"吐槽"==t&&this.setData({swithObj:swithArr[2]}),console.log(selectSorrowArr),console.log(selectDiaryWeatherArr),console.log(selectComplainWeatherArr),this.Start(app.globalData.openid)},onReady:function(){},onShow:function(){},onHide:function(){},onUnload:function(){selectSorrowArr=[],selectDiaryWeatherArr=[],selectComplainWeatherArr=[]},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){}});