import WxCanvas from"./wx-canvas";import*as echarts from"./echarts";let ctx;function compareVersion(t,a){t=t.split("."),a=a.split(".");for(var s=Math.max(t.length,a.length);t.length<s;)t.push("0");for(;a.length<s;)a.push("0");for(let e=0;e<s;e++){var c=parseInt(t[e]),n=parseInt(a[e]);if(n<c)return 1;if(c<n)return-1}return 0}function wrapTouch(t){for(let e=0;e<t.touches.length;++e){const a=t.touches[e];a.offsetX=a.x,a.offsetY=a.y}return t}Component({properties:{canvasId:{type:String,value:"ec-canvas"},ec:{type:Object},forceUseOldCanvas:{type:Boolean,value:!1}},data:{isUseNewCanvas:!1},ready:function(){echarts.registerPreprocessor(e=>{e&&e.series&&(0<e.series.length?e.series.forEach(e=>{e.progressive=0}):"object"==typeof e.series&&(e.series.progressive=0))}),this.data.ec?this.data.ec.lazyLoad||this.init():console.warn('组件需绑定 ec 变量，例：<ec-canvas id="mychart-dom-bar" canvas-id="mychart-bar" ec="{{ ec }}"></ec-canvas>')},methods:{init:function(e){var t=wx.getSystemInfoSync().SDKVersion,a=0<=compareVersion(t,"2.9.0"),s=this.data.forceUseOldCanvas,c=a&&!s;this.setData({isUseNewCanvas:c}),s&&a&&console.warn("开发者强制使用旧canvas,建议关闭"),c?this.initByNewWay(e):0<=compareVersion(t,"1.9.91")?(console.warn("建议将微信基础库调整大于等于2.9.0版本。升级后绘图将有更好性能"),this.initByOldWay(e)):console.error("微信基础库版本过低，需大于等于 1.9.91。参见：https://github.com/ecomfe/echarts-for-weixin#%E5%BE%AE%E4%BF%A1%E7%89%88%E6%9C%AC%E8%A6%81%E6%B1%82")},initByOldWay(t){ctx=wx.createCanvasContext(this.data.canvasId,this);const a=new WxCanvas(ctx,this.data.canvasId,!1);echarts.setCanvasCreator(()=>a);wx.createSelectorQuery().in(this).select(".ec-canvas").boundingClientRect(e=>{"function"==typeof t?this.chart=t(a,e.width,e.height,1):this.data.ec&&"function"==typeof this.data.ec.onInit?this.chart=this.data.ec.onInit(a,e.width,e.height,1):this.triggerEvent("init",{canvas:a,width:e.width,height:e.height,canvasDpr:1})}).exec()},initByNewWay(r){const e=wx.createSelectorQuery().in(this);e.select(".ec-canvas").fields({node:!0,size:!0}).exec(e=>{const t=e[0].node;this.canvasNode=t;var a=wx.getSystemInfoSync().pixelRatio,s=e[0].width,c=e[0].height,e=t.getContext("2d");const n=new WxCanvas(e,this.data.canvasId,!0,t);echarts.setCanvasCreator(()=>n),"function"==typeof r?this.chart=r(n,s,c,a):this.data.ec&&"function"==typeof this.data.ec.onInit?this.chart=this.data.ec.onInit(n,s,c,a):this.triggerEvent("init",{canvas:n,width:s,height:c,dpr:a})})},canvasToTempFilePath(t){if(this.data.isUseNewCanvas){const e=wx.createSelectorQuery().in(this);e.select(".ec-canvas").fields({node:!0,size:!0}).exec(e=>{e=e[0].node;t.canvas=e,wx.canvasToTempFilePath(t)})}else t.canvasId||(t.canvasId=this.data.canvasId),ctx.draw(!0,()=>{wx.canvasToTempFilePath(t,this)})},touchStart(e){var t,a;this.chart&&0<e.touches.length&&(t=e.touches[0],(a=this.chart.getZr().handler).dispatch("mousedown",{zrX:t.x,zrY:t.y}),a.dispatch("mousemove",{zrX:t.x,zrY:t.y}),a.processGesture(wrapTouch(e),"start"))},touchMove(e){var t,a;this.chart&&0<e.touches.length&&(t=e.touches[0],(a=this.chart.getZr().handler).dispatch("mousemove",{zrX:t.x,zrY:t.y}),a.processGesture(wrapTouch(e),"change"))},touchEnd(e){var t,a;this.chart&&(t=e.changedTouches?e.changedTouches[0]:{},(a=this.chart.getZr().handler).dispatch("mouseup",{zrX:t.x,zrY:t.y}),a.dispatch("click",{zrX:t.x,zrY:t.y}),a.processGesture(wrapTouch(e),"end"))}}});