"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var component_1=require("../common/component"),utils_1=require("../common/utils"),color_1=require("../common/color"),canvas_1=require("./canvas");function format(e){return Math.min(Math.max(e,0),100)}var PERIMETER=2*Math.PI,BEGIN_ANGLE=-Math.PI/2,STEP=1;component_1.VantComponent({props:{text:String,lineCap:{type:String,value:"round"},value:{type:Number,value:0,observer:"reRender"},speed:{type:Number,value:50},size:{type:Number,value:100,observer:function(){this.drawCircle(this.currentValue)}},fill:String,layerColor:{type:String,value:color_1.WHITE},color:{type:[String,Object],value:color_1.BLUE,observer:function(){var e=this;this.setHoverColor().then(function(){e.drawCircle(e.currentValue)})}},type:{type:String,value:""},strokeWidth:{type:Number,value:4},clockwise:{type:Boolean,value:!0}},data:{hoverColor:color_1.BLUE},methods:{getContext:function(){var n=this,e=this.data,a=e.type,i=e.size;if(""===a){e=wx.createCanvasContext("van-circle",this);return Promise.resolve(e)}var o=wx.getSystemInfoSync().pixelRatio;return new Promise(function(r){wx.createSelectorQuery().in(n).select("#van-circle").node().exec(function(e){var t=e[0].node,e=t.getContext(a);n.inited||(n.inited=!0,t.width=i*o,t.height=i*o,e.scale(o,o)),r(canvas_1.adaptor(e))})})},setHoverColor:function(){var r=this,e=this.data,n=e.color,a=e.size;return utils_1.isObj(n)?this.getContext().then(function(e){var t=e.createLinearGradient(a,0,0,0);Object.keys(n).sort(function(e,t){return parseFloat(e)-parseFloat(t)}).map(function(e){return t.addColorStop(parseFloat(e)/100,n[e])}),r.hoverColor=t}):(this.hoverColor=n,Promise.resolve())},presetCanvas:function(e,t,r,n,a){var i=this.data,o=i.strokeWidth,l=i.lineCap,s=i.clockwise,c=i.size/2,i=c-o/2;e.setStrokeStyle(t),e.setLineWidth(o),e.setLineCap(l),e.beginPath(),e.arc(c,c,i,r,n,!s),e.stroke(),a&&(e.setFillStyle(a),e.fill())},renderLayerCircle:function(e){var t=this.data,r=t.layerColor,t=t.fill;this.presetCanvas(e,r,0,PERIMETER,t)},renderHoverCircle:function(e,t){var r=this.data.clockwise,t=PERIMETER*(t/100),t=r?BEGIN_ANGLE+t:3*Math.PI-(BEGIN_ANGLE+t);this.presetCanvas(e,this.hoverColor,BEGIN_ANGLE,t)},drawCircle:function(r){var n=this,a=this.data.size;this.getContext().then(function(e){e.clearRect(0,0,a,a),n.renderLayerCircle(e);var t=format(r);0!==t&&n.renderHoverCircle(e,t),e.draw()})},reRender:function(){var e=this,t=this.data,r=t.value,t=t.speed;t<=0||1e3<t?this.drawCircle(r):(this.clearInterval(),this.currentValue=this.currentValue||0,this.interval=setInterval(function(){e.currentValue!==r?(e.currentValue<r?e.currentValue+=STEP:e.currentValue-=STEP,e.drawCircle(e.currentValue)):e.clearInterval()},1e3/t))},clearInterval:function(){this.interval&&(clearInterval(this.interval),this.interval=null)}},mounted:function(){var e=this;this.currentValue=this.data.value,this.setHoverColor().then(function(){e.drawCircle(e.currentValue)})},destroyed:function(){this.clearInterval()}});