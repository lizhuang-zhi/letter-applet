import Dialog from"../../../miniprogram_npm/@vant/weapp/dialog/dialog";let requestData=require("../../../utils/request"),timeTools=require("../../../utils/timeTools.js"),yeoTools=require("../../../Yeo/utils/tools"),state=3,app=getApp();Page({data:{isShowLoading:!0,commentArr:[],id:"",inputContent:"",preViousTime:0,commentBackInfo:"",sendMsgBeforeTime:0,commentPageNum:1,isLastPageNum:!1},inputEvent(t){t=t.detail.realtime_comment;this.setData({inputContent:t})},sendmessageEvent(t){var e=this,a=e.data.sendMsgBeforeTime;1e3<=(new Date).getTime()-a?""==(a=e.data.inputContent)?wx.showToast({title:"请输入评论内容",icon:"none"}):(e.setData({sendMsgBeforeTime:new Date}),e.sendMsg(a)):wx.showToast({title:"点击过于频繁",icon:"none"})},sendMsg(t){var e=this.data.preViousTime,o=new Date;if(3e3<=o-e){wx.showLoading({title:"审核中.."});let e={content:t,date:timeTools.indexPostBoxTime(o),userVo:{penName:app.globalData.userInfo.nickName,avatarUrl:app.globalData.userInfo.avatarUrl}};o={openId:app.globalData.openid,sgId:this.data.id,state:state};let a=Object.assign(e,o);requestData.textLegal(t).then(t=>{console.log(t.data.data),1==t.data.data?this.userComment(e,a):(wx.hideLoading({}),Dialog.alert({title:"审核结果",message:"小主，您的内容有些不当哦！请修改后重试",theme:"round-button"}).then(()=>{}))})}else wx.showToast({title:"发送过于频繁",icon:"none"})},userComment(a,t){requestData.complainletterSendComment(t).then(t=>{console.log(t);t=t.data.resultCode;let e=this.data.commentArr;200==t?(e.unshift(a),this.setData({commentArr:e,preViousTime:new Date,initValue:"",inputContent:""}),wx.showToast({title:"发布成功",icon:"none"})):wx.showToast({title:"服务器开了个小差",icon:"none"})})},Start(a){requestData.complainDetail(a).then(e=>{if(200!=e.statusCode)return new Promise((t,e)=>{t("error")});{let t=e.data.data;return t.date=timeTools.indexBeautyTime(t.date),t.content=t.content.split("\n"),this.setData({complianObj:t}),requestData.complainDetailComment(a,this.data.commentPageNum)}}).then(o=>new Promise((e,a)=>{if("error"==o)console.log(o),a("error");else{a=o.data.data;let t=a.list;console.log(t),t.forEach(t=>{t.date=timeTools.indexPostBoxTime(t.date)}),this.setData({commentArr:t,isLastPageNum:a.isLastPage}),e("success")}})).then(t=>{"success"==t?this.setData({isShowLoading:!1}):console.log("服务器请求错误！！")})},onLoad:function(t){this.Start(t.id),this.setData({id:t.id}),console.log("complaintletter页面  ---\x3e  监听页面加载")},onReady:function(){},onShow:function(){console.log("complaintletter页面  ---\x3e  监听页面显示")},onHide:function(){},onUnload:function(){console.log("complaintletter页面  ---\x3e  监听页面卸载")},onPullDownRefresh:function(){},onReachBottom:function(){if(console.log("触底了！！！"),this.data.isLastPageNum)wx.showToast({title:"我是有底线的",icon:"none"});else{let e=this.data.id;wx.showLoading({title:"加载数据..."}).then(t=>requestData.complainDetailComment(e,++this.data.commentPageNum)).then(n=>new Promise((t,e)=>{var a=n.data.data;let o=a.list;o.forEach(t=>{t.date=timeTools.indexPostBoxTime(t.date)}),console.log(o),this.setData({isLastPageNum:a.isLastPage,commentArr:this.data.commentArr.concat(o)}),t("success")})).then(t=>{"success"==t&&wx.hideLoading({})})}},onShareAppMessage:function(){}});